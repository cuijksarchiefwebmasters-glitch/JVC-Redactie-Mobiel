<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>JVC Cuijk Redactie Dashboard</title>
  <style>
    body { font-family: Arial; margin: 0; background: #fff; }
    header { background: red; color: white; padding: 1rem; display: flex; justify-content: space-between; align-items: center; }
    header img { height: 50px; }
    header button { background: white; color: red; padding: 0.5rem 1rem; border: none; border-radius: 4px; cursor: pointer; }
    main { max-width: 800px; margin: 1rem auto; padding: 0 1rem; }
    h2 { color: red; }
    label { font-weight: bold; margin: 1rem 0 0.3rem; display: block; }
    input, textarea, select, button { width: 100%; padding: 0.6rem; margin-top: 0.3rem; box-sizing: border-box; }
    button { background: red; color: white; border: none; cursor: pointer; margin-top: 1rem; }
    .message { font-weight: bold; margin-top: 0.5rem; }
    .section { border: 1px solid #ddd; padding: 1rem; margin-bottom: 2rem; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    #content.hidden, #loginForm.hidden { display: none; }
  </style>
</head>
<body>
  <header>
    <img src="JVC_Logo.png" alt="JVC Cuijk Logo" />
    <button id="logoutBtn" style="display: none;">Afmelden</button>
  </header>
  <main>
    <div id="loginForm" class="section">
      <h2>Inloggen Redactie</h2>
      <p>Bezig met verbinden...</p>
      <p id="loginMessage" class="message"></p>
    </div>

    <div id="content" class="hidden">
      <div id="imgUploadForm" class="section">
        <h2>Afbeelding uploaden</h2>
        <form>
          <label for="imgfile">Afbeelding:</label>
          <input type="file" id="imgfile" name="imgfile" accept="image/*" />
          <label for="imgsectie">Sectie:</label>
          <select id="imgsectie" name="sectie">
            <option value="JVC Cuijk">JVC Cuijk</option>
            <option value="JVC-C25">JVC-C25</option>
            <option value="Meiden">Meiden</option>
            <option value="Jongste Jeugd">Jongste Jeugd</option>
            <option value="Jeugd">Jeugd</option>
            <option value="Senioren">Senioren</option>
          </select>
          <button type="submit">Uploaden</button>
        </form>
        <p id="imgMessage" class="message"></p>
      </div>

      <div id="docUploadForm" class="section">
        <h2>Document uploaden</h2>
        <form>
          <label for="docfile">Document:</label>
          <input type="file" id="docfile" name="docfile" />
          <label for="docsectie">Sectie:</label>
          <select id="docsectie" name="sectie">
            <option value="JVC Cuijk">JVC Cuijk</option>
            <option value="JVC-C25">JVC-C25</option>
            <option value="Meiden">Meiden</option>
            <option value="Jongste Jeugd">Jongste Jeugd</option>
            <option value="Jeugd">Jeugd</option>
            <option value="Senioren">Senioren</option>
          </select>
          <button type="submit">Uploaden</button>
        </form>
        <p id="docMessage" class="message"></p>
      </div>

      <div id="videoUploadForm" class="section">
        <h2>Video uploaden</h2>
        <form>
          <label for="videofile">Video:</label>
          <input type="file" id="videofile" name="videofile" accept="video/*" />
          <label for="videosectie">Sectie:</label>
          <select id="videosectie" name="sectie">
            <option value="JVC Cuijk">JVC Cuijk</option>
            <option value="JVC-C25">JVC-C25</option>
            <option value="Meiden">Meiden</option>
            <option value="Jongste Jeugd">Jongste Jeugd</option>
            <option value="Jeugd">Jeugd</option>
            <option value="Senioren">Senioren</option>
          </select>
          <button type="submit">Uploaden</button>
        </form>
        <p id="videoMessage" class="message"></p>
      </div>
    </div>
  </main>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, collection, addDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

    // Zet logniveau voor debuggen van Firebase
    setLogLevel('debug');

    // Gebruik de globalen die de omgeving aanlevert
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

    let db, auth, storage, userId;

    const loginForm = document.getElementById("loginForm");
    const loginMessage = document.getElementById("loginMessage");
    const contentDiv = document.getElementById("content");
    const logoutBtn = document.getElementById("logoutBtn");

    // Initialiseert Firebase en authenticatie
    const initializeFirebase = async () => {
        try {
            const app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            storage = getStorage(app);

            // Luistert naar veranderingen in de authenticatiestatus
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    loginForm.style.display = 'none';
                    contentDiv.classList.remove('hidden');
                    logoutBtn.style.display = 'block';
                    console.log("Gebruiker succesvol aangemeld:", userId);
                } else {
                    console.log("Geen gebruiker is ingelogd. Probeer aan te melden.");
                    try {
                        if (initialAuthToken) {
                            await signInWithCustomToken(auth, initialAuthToken);
                        } else {
                            await signInAnonymously(auth);
                        }
                    } catch (signInError) {
                        console.error("Fout bij het aanmelden:", signInError);
                        loginMessage.innerText = "❌ Fout bij het aanmelden. Probeer het opnieuw.";
                    }
                }
            });

        } catch (error) {
            console.error("Fout bij het initialiseren van Firebase:", error);
            loginMessage.innerText = "❌ Fout bij het laden.";
        }
    };

    // Functie om een bestand te uploaden naar Firebase Storage
    const uploadToStorage = async (file) => {
        const storagePath = `uploads/${userId}/${Date.now()}_${file.name}`;
        const storageRef = ref(storage, storagePath);
        await uploadBytes(storageRef, file);
        return await getDownloadURL(storageRef);
    };

    // Functie om de metadata van een bestand op te slaan in Firestore
    const saveFileMetadata = async (fileUrl, fileType, sectie, originalName) => {
        const collectionPath = `/artifacts/${appId}/public/data/jvc-redactie`;
        await addDoc(collection(db, collectionPath), {
            url: fileUrl,
            type: fileType,
            sectie: sectie,
            filename: originalName,
            uploadedAt: Date.now(),
            uploadedBy: userId
        });
    };

    // Event listener voor het uploaden van afbeeldingen
    document.getElementById("imgUploadForm").onsubmit = async (e) => {
        e.preventDefault();
        const imgfile = document.getElementById("imgfile").files[0];
        const sectie = document.getElementById("imgsectie").value;
        const msg = document.getElementById("imgMessage");

        if (!imgfile) {
            msg.innerText = "❌ Selecteer een afbeelding om te uploaden.";
            return;
        }

        msg.innerText = "⏳ Bezig met uploaden...";
        try {
            const fileUrl = await uploadToStorage(imgfile);
            await saveFileMetadata(fileUrl, 'afbeelding', sectie, imgfile.name);
            msg.innerText = "✅ Afbeelding succesvol geüpload!";
        } catch (error) {
            console.error("Fout bij het uploaden van de afbeelding:", error);
            msg.innerText = "❌ Fout bij het uploaden. Probeer het opnieuw.";
        }
    };

    // Event listener voor het uploaden van documenten
    document.getElementById("docUploadForm").onsubmit = async (e) => {
        e.preventDefault();
        const docfile = document.getElementById("docfile").files[0];
        const sectie = document.getElementById("docsectie").value;
        const msg = document.getElementById("docMessage");

        if (!docfile) {
            msg.innerText = "❌ Selecteer een document om te uploaden.";
            return;
        }

        msg.innerText = "⏳ Bezig met uploaden...";
        try {
            const fileUrl = await uploadToStorage(docfile);
            await saveFileMetadata(fileUrl, 'document', sectie, docfile.name);
            msg.innerText = "✅ Document succesvol geüpload!";
        } catch (error) {
            console.error("Fout bij het uploaden van het document:", error);
            msg.innerText = "❌ Fout bij het uploaden. Probeer het opnieuw.";
        }
    };

    // Event listener voor het uploaden van video's
    document.getElementById("videoUploadForm").onsubmit = async (e) => {
        e.preventDefault();
        const videofile = document.getElementById("videofile").files[0];
        const sectie = document.getElementById("videosectie").value;
        const msg = document.getElementById("videoMessage");

        if (!videofile) {
            msg.innerText = "❌ Selecteer een video om te uploaden.";
            return;
        }

        msg.innerText = "⏳ Bezig met uploaden...";
        try {
            const fileUrl = await uploadToStorage(videofile);
            await saveFileMetadata(fileUrl, 'video', sectie, videofile.name);
            msg.innerText = "✅ Video succesvol geüpload!";
        } catch (error) {
            console.error("Fout bij het uploaden van de video:", error);
            msg.innerText = "❌ Fout bij het uploaden. Probeer het opnieuw.";
        }
    };

    // Logout-knop
    logoutBtn.onclick = () => {
        auth.signOut();
    };

    // Initialiseer de app
    initializeFirebase();
  </script>
</body>
</html>
